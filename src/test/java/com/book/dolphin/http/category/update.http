### 0) 공통 베이스 URL
@baseUrl = http://localhost:10000/api/v1/categories

### 1) 루트: 남성
# @name create_men_root
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "남성",
  "slug": "men",
  "status": "ACTIVE"
}

> {% client.global.set("MEN_ID", response.body.data.id); %}

### 2) 루트: 여성
# @name create_women_root
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "여성",
  "slug": "women",
  "status": "ACTIVE"
}

> {% client.global.set("WOMEN_ID", response.body.data.id); %}


### 3) 남성/상의 (parent = 남성)
# @name create_men_top
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "상의",
  "slug": "top",
  "parentId": {{MEN_ID}},
  "status": "ACTIVE"
}

> {% client.global.set("MEN_TOP_ID", response.body.data.id); %}

### 4) 남성/하의 (parent = 남성)
# @name create_men_bottom
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "하의",
  "slug": "bottom",
  "parentId": {{MEN_ID}},
  "status": "ACTIVE"
}

> {% client.global.set("MEN_BOTTOM_ID", response.body.data.id); %}

### 5) 남성/상의/셔츠 (parent = 남성/상의)
# @name create_men_top_shirts
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "셔츠",
  "slug": "shirts",
  "parentId": {{MEN_TOP_ID}},
  "status": "ACTIVE"
}

### 6) 남성/하의/청바지 (parent = 남성/하의)
# @name create_men_bottom_jeans
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "청바지",
  "slug": "jeans",
  "parentId": {{MEN_BOTTOM_ID}},
  "status": "ACTIVE"
}


### 7) 여성/상의 (parent = 여성)
# @name create_women_top
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "상의",
  "slug": "top",
  "parentId": {{WOMEN_ID}},
  "status": "ACTIVE"
}

> {% client.global.set("WOMEN_TOP_ID", response.body.data.id); %}

### 8) 여성/아우터 (parent = 여성)
# @name create_women_outer
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "아우터",
  "slug": "outer",
  "parentId": {{WOMEN_ID}},
  "status": "ACTIVE"
}

> {% client.global.set("WOMEN_OUTER_ID", response.body.data.id); %}

### 9) 여성/상의/셔츠 (parent = 여성/상의)
# @name create_women_top_shirts
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "셔츠",
  "slug": "shirts",
  "parentId": {{WOMEN_TOP_ID}},
  "status": "ACTIVE"
}

### 10) 여성/아우터/코트 (parent = 여성/아우터)
# @name create_women_outer_coat
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "코트",
  "slug": "coat",
  "parentId": {{WOMEN_OUTER_ID}},
  "status": "ACTIVE"
}

### 조회(메가메뉴/상세) 검증
### 11) 메가메뉴 기본 (selectedRoot 미지정 → 첫 루트 선택)
# @name get_mega_default
GET {{baseUrl}}?view=mega&activeOnly=true

> {%
  client.test("mega default - 200", function () {
    client.assert(response.status === 200, "status should be 200");
    const data = response.body.data;
    client.assert(!!data, "data exists");
    client.assert(Array.isArray(data.roots), "roots array");
    client.assert(!!data.selectedRoot, "selectedRoot exists");
    client.assert(Array.isArray(data.childrenOfSelectedRoot), "childrenOfSelectedRoot array");
  });
%}

### 12) 메가메뉴 (남성 선택)
# @name get_mega_men
GET {{baseUrl}}?view=mega&selectedRootId={{MEN_ID}}&activeOnly=true

> {%
  client.test("mega men - selectedRoot is 남성", function () {
    client.assert(response.status === 200, "status 200");
    const sel = response.body.data.selectedRoot;
    client.assert(sel.id === Number(client.global.get("MEN_ID")), "selected root is MEN");
  });
%}

### 13) 메가메뉴 (여성 선택)
# @name get_mega_women
GET {{baseUrl}}?view=mega&selectedRootId={{WOMEN_ID}}&activeOnly=true

> {%
  client.test("mega women - selectedRoot is 여성", function () {
    client.assert(response.status === 200, "status 200");
    const sel = response.body.data.selectedRoot;
    client.assert(sel.id === Number(client.global.get("WOMEN_ID")), "selected root is WOMEN");
  });
%}

### 14) 상세: 남성/상의 (children,breadcrumb)
# @name get_detail_men_top_children
GET {{baseUrl}}/{{MEN_TOP_ID}}?activeOnly=true&include=children,breadcrumb

> {%
  client.test("detail men/top - has children 셔츠", function () {
    client.assert(response.status === 200, "status 200");
    const d = response.body.data;
    client.assert(d.category.path === "/men/top", "path=/men/top");
    const names = d.children.map(x => x.name);
    client.assert(names.includes("셔츠"), "has 셔츠");
  });
%}

### 15) 상세: 여성/아우터 (children,breadcrumb)
# @name get_detail_women_outer_children
GET {{baseUrl}}/{{WOMEN_OUTER_ID}}?activeOnly=true&include=children,breadcrumb

> {%
  client.test("detail women/outer - children include 코트", function () {
    client.assert(response.status === 200, "status 200");
    const d = response.body.data;
    const names = d.children.map(x => x.name);
    client.assert(names.includes("코트"), "children has 코트");
  });
%}

### 기본 속성 수정(Update Basic) 검증
### 16) 남성/상의 기본정보 수정 (이름, 이미지, 정렬, 상태)
# @name patch_update_basic_men_top
PATCH {{baseUrl}}/{{MEN_TOP_ID}}
Content-Type: application/json

{
  "name": "상의(수정)",
  "imageUrl": "https://cdn.example.com/category/men-top.jpg",
  "sortOrder": 3,
  "status": "ACTIVE"
}

> {%
  client.test("update basic - 200", function () {
    client.assert(response.status === 200, "status 200");
    client.assert(response.body.code === "SUCCESS", "SUCCESS code");
  });
%}

### 17) 수정 후 상세 재확인
# @name get_detail_men_top_after_update
GET {{baseUrl}}/{{MEN_TOP_ID}}?activeOnly=true&include=children,breadcrumb

> {%
  client.test("detail after update - reflects new name/image/sort", function () {
    client.assert(response.status === 200, "status 200");
    const cat = response.body.data.category;
    client.assert(cat.name.includes("수정"), "name updated");
    client.assert(!!cat.imageUrl, "imageUrl set");
  });
%}

### 이동(Move) 성공/실패 시나리오
### 18) 이동: 남성/상의(MEN_TOP)를 여성/아우터(WOMEN_OUTER) 아래로 이동
# @name move_men_top_under_women_outer
PATCH {{baseUrl}}/{{MEN_TOP_ID}}/move
Content-Type: application/json

{
  "newParentId": {{WOMEN_OUTER_ID}}
}

> {%
  client.test("move - men/top -> women/outer", function () {
    client.assert(response.status === 200, "status 200");
    const data = response.body.data;
    client.assert(!!data, "has response data");
    client.assert(data.newParentId === Number(client.global.get("WOMEN_OUTER_ID")), "new parent ok");
    client.assert(data.path.startsWith("/women/outer/top"), "path changed under women/outer");
    client.assert(Array.isArray(data.breadcrumb), "breadcrumb present");
  });
%}

### 19) 이동 결과 상세 조회 (include=breadcrumb,children)
GET {{baseUrl}}/{{MEN_TOP_ID}}?activeOnly=true&include=breadcrumb,children

> {%
  client.test("detail after move - breadcrumb starts with 여성", function () {
    client.assert(response.status === 200, "status 200");
    const bc = response.body.data.breadcrumb.map(x => x.name);
    client.assert(bc[0] === "여성", "root is 여성 now");
  });
%}

### 20) 이동: 남성/하의(MEN_BOTTOM)를 루트로 승격(newParentId=null)
# @name move_men_bottom_to_root
PATCH {{baseUrl}}/{{MEN_BOTTOM_ID}}/move
Content-Type: application/json

{
  "newParentId": null
}

> {%
  client.test("move - men/bottom -> root", function () {
    client.assert(response.status === 200, "status 200");
    const data = response.body.data;
    client.assert(data.newParentId === null, "now root");
    client.assert(data.path === "/bottom", "new root path ok");
  });
%}

### 21) (실패 케이스) 사이클 방지: 남성 루트를 자신의 자손 밑으로 이동 시도
# men(루트) -> men/top(지금은 women/outer/top으로 옮겨졌으니, 실패 유도용으로 women/outer/top ID 사용)
# @name move_men_root_under_men_top_should_fail
PATCH {{baseUrl}}/{{MEN_ID}}/move
Content-Type: application/json

{
  "newParentId": {{MEN_TOP_ID}}
}

> {%
  client.test("move fail - cycle prevention", function () {
    // 전역 예외 핸들러 정책에 따라 400/409/422/500 등일 수 있음.
    client.assert(response.status === 200 || response.status === 400 || response.status === 409, "status is error-ish");
    client.assert(response.body.code !== "SUCCESS", "should not be SUCCESS");
  });
%}

### 22-0) 여성/상의 밑에 slug=top 자식 하나 미리 생성 (중복 유도용)
POST {{baseUrl}}/create
Content-Type: application/json

{
  "name": "탑-복제",
  "slug": "top",
  "parentId": {{WOMEN_TOP_ID}},
  "status": "ACTIVE"
}

### 22) (실패 케이스) slug 충돌: 여성/상의 아래에 slug=top 중복 이동 시도
# 현재 women/top이 이미 존재하므로, women/top 밑으로 top 가진 노드를 다시 이동하면 DUPLICATE_SLUG 오류 기대
# @name move_conflict_slug_should_fail
PATCH {{baseUrl}}/{{MEN_TOP_ID}}/move
Content-Type: application/json

{
  "newParentId": {{WOMEN_TOP_ID}}
}

> {%
  client.test("move fail - duplicate slug under same parent", function () {
    client.assert(response.status === 200 || response.status === 409, "status 200 or 409");
    if (response.body && response.body.message) {
      client.assert(response.body.message.includes("중복") || response.body.message.includes("slug"), "duplicate slug message likely");
    }
  });
%}

### 22.9) 선행 정리: 남성을 루트로 되돌리기
# @name move_men_back_to_root_before_23
PATCH {{baseUrl}}/{{MEN_ID}}/move
Content-Type: application/json

{
  "newParentId": null
}

> {%
  client.test("prep - men back to root", function () {
    client.assert(response.status === 200, "status 200");
    const data = response.body.data;
    client.assert(data.newParentId === null, "men is root again");
    client.assert(data.path === "/men", "men path is /men");
  });
%}

### (선택) 되돌리기 / 추가 검증
### 23) 다시 이동: women/outer/top -> men(루트)로 복귀
# @name move_back_to_men
PATCH {{baseUrl}}/{{MEN_TOP_ID}}/move
Content-Type: application/json

{
  "newParentId": {{MEN_ID}}
}

> {%
  client.test("move back - ok", function () {
    client.assert(response.status === 200, "status 200");
    const data = response.body.data;
    client.assert(data.newParentId === Number(client.global.get("MEN_ID")), "parent is men");
    client.assert(data.path.startsWith("/men/top"), "path changed under men");
  });
%}

### 24) 상세 재확인
# @name get_detail_after_move_back
GET {{baseUrl}}/{{MEN_TOP_ID}}?activeOnly=true&include=breadcrumb,children

> {%
  client.test("detail after move back - breadcrumb starts with 남성", function () {
    client.assert(response.status === 200, "status 200");
    const bc = response.body.data.breadcrumb.map(x => x.name);
    client.assert(bc[0] === "남성", "root is 남성 again");
  });
%}
